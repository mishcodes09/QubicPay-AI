# üöÄ Deployment Guide

Complete guide for deploying Qubic Smart Escrow to testnet and production.

---

## üéØ Quick Start

```bash
# 1. Complete setup
./setup.sh

# 2. Deploy everything
./scripts/deploy-all.sh testnet

# 3. Verify deployment
curl http://localhost:5000/health
curl http://localhost:8080/health
```

---

## üìã Prerequisites

### Required Software
- Node.js 18+
- Python 3.9+
- npm 9+
- Git
- curl

### Optional
- Docker & Docker Compose
- Qubic CLI
- jq (JSON processing)

### Accounts Needed
- Qubic testnet wallets (generated by setup)
- Domain name (for production)
- SSL certificates (for production)

---

## üîß Environment Setup

### 1. Clone Repository
```bash
git clone https://github.com/your-org/qubic-smart-escrow.git
cd qubic-smart-escrow
```

### 2. Run Master Setup
```bash
chmod +x setup.sh
./setup.sh
```

This handles:
- Dependency installation
- Wallet generation
- Service builds
- Configuration files

### 3. Configure Environment
Edit `.env` with your specific values:
```bash
# Critical settings
CONTRACT_ID=<deployed_contract_id>
ORACLE_PUBLIC_KEY=<from_wallets.json>
ORACLE_PRIVATE_KEY=<from_wallets.json>

# Optional overrides
QUBIC_RPC_ENDPOINT=https://testnet-rpc.qubic.org/
AI_SERVICE_URL=http://localhost:5000
```

---

## üì¶ Component Deployment

### Smart Contract

```bash
cd contract
chmod +x deploy/deploy.sh
./deploy/deploy.sh testnet
```

**Outputs**:
- Contract ID
- Deployment transaction hash
- Deployment block/tick

**Save these** in `contract/deploy/deployment-result.json`

### AI Service

```bash
cd backend/ai-verification
source venv/bin/activate
python src/ai_verifier.py
```

**Verify**:
```bash
curl http://localhost:5000/health
```

### Oracle Agent

```bash
cd backend/oracle-agent
npm run build
npm start
```

**Verify**:
```bash
curl http://localhost:8080/health
```

### Frontend

```bash
cd frontend
npm run build
npm start
```

**Verify**: Open http://localhost:3000

---

## üê≥ Docker Deployment

### Build Images
```bash
docker-compose build
```

### Run All Services
```bash
docker-compose up -d
```

### Check Status
```bash
docker-compose ps
docker-compose logs -f
```

### Stop Services
```bash
docker-compose down
```

---

## ‚òÅÔ∏è Production Deployment

### AWS Deployment

**1. Setup EC2 Instance**
```bash
# t3.medium or larger recommended
# Ubuntu 22.04 LTS
# Open ports: 22, 80, 443, 5000, 8080, 3000
```

**2. Install Dependencies**
```bash
sudo apt update
sudo apt install -y nodejs npm python3-pip nginx certbot
```

**3. Clone and Setup**
```bash
git clone <repo>
cd qubic-smart-escrow
./setup.sh
```

**4. Configure Nginx**
```nginx
server {
    listen 80;
    server_name api.yourdomain.com;
    
    location / {
        proxy_pass http://localhost:5000;
        proxy_set_header Host $host;
    }
}
```

**5. Setup SSL**
```bash
sudo certbot --nginx -d api.yourdomain.com
```

**6. Setup Systemd Services**
```bash
# See systemd/ directory for service files
sudo cp systemd/*.service /etc/systemd/system/
sudo systemctl enable qubic-ai.service
sudo systemctl enable qubic-oracle.service
sudo systemctl start qubic-ai.service
sudo systemctl start qubic-oracle.service
```

### DigitalOcean Deployment

**1. Create Droplet**
- Size: 2GB RAM minimum
- Image: Ubuntu 22.04
- Add SSH key

**2. Deploy**
```bash
ssh root@your-droplet-ip
git clone <repo>
cd qubic-smart-escrow
./scripts/deploy-all.sh testnet
```

**3. Configure Firewall**
```bash
ufw allow 22
ufw allow 80
ufw allow 443
ufw enable
```

### Vercel Deployment (Frontend Only)

```bash
cd frontend
vercel deploy --prod
```

---

## üîê Security Checklist

### Pre-Deployment
- [ ] Change all default passwords
- [ ] Generate new wallet keys
- [ ] Review `.env` file (no secrets committed)
- [ ] Enable firewall rules
- [ ] Setup SSL certificates
- [ ] Configure CORS properly
- [ ] Enable rate limiting

### Post-Deployment
- [ ] Test all endpoints
- [ ] Verify smart contract deployed
- [ ] Check oracle authorization
- [ ] Monitor logs for errors
- [ ] Setup backup system
- [ ] Configure monitoring/alerts

---

## üìä Monitoring

### Logs
```bash
# AI Service
tail -f logs/ai-service.log

# Oracle Agent
tail -f logs/oracle-agent.log

# Frontend
tail -f logs/frontend.log

# System
journalctl -u qubic-ai.service -f
```

### Health Checks
```bash
# Automated health check script
./scripts/health-check.sh
```

### Metrics
- Request rate
- Response time
- Error rate
- Queue depth
- Contract state

---

## üîÑ Updates & Maintenance

### Update AI Service
```bash
cd backend/ai-verification
git pull
pip install -r requirements.txt
sudo systemctl restart qubic-ai.service
```

### Update Oracle Agent
```bash
cd backend/oracle-agent
git pull
npm install
npm run build
sudo systemctl restart qubic-oracle.service
```

### Update Frontend
```bash
cd frontend
git pull
npm install
npm run build
# Deploy new build
```

### Database Backup
```bash
# Backup configuration
cp -r config/ backups/config-$(date +%Y%m%d)/

# Backup logs
tar -czf logs-$(date +%Y%m%d).tar.gz logs/
```

---

## üß™ Testing Deployment

### Smoke Tests
```bash
# Run automated tests
./scripts/test-deployment.sh
```

### Manual Tests
1. ‚úÖ Health endpoints respond
2. ‚úÖ Can verify a post
3. ‚úÖ Oracle submits scores
4. ‚úÖ Frontend loads
5. ‚úÖ Wallet connection works
6. ‚úÖ Demo scenarios run

---

## üêõ Troubleshooting

### Services Won't Start
```bash
# Check ports
lsof -i :5000
lsof -i :8080

# Check logs
journalctl -xe

# Restart services
./scripts/stop-all.sh
./scripts/start-all.sh
```

### Contract Not Deploying
```bash
# Check Qubic CLI
qubic-cli version

# Verify network connection
curl https://testnet-rpc.qubic.org/health

# Check wallet balance
qubic-cli balance <DEPLOYER_PUBLIC_KEY>
```

### Oracle Not Submitting
```bash
# Check oracle authorization
qubic-cli query <CONTRACT_ID> getContractState

# Verify private key in .env
grep ORACLE_PRIVATE_KEY .env

# Check AI service connection
curl http://localhost:5000/health
```

---

## üìö Deployment Scenarios

### Scenario 1: Local Development
```bash
./scripts/start-all.sh
# All services on localhost
```

### Scenario 2: Testnet Demo
```bash
./scripts/deploy-all.sh testnet
# Contract on testnet
# Services on local/VPS
```

### Scenario 3: Production
```bash
# Contract on mainnet
# Services on cloud infrastructure
# Load balancers
# CDN for frontend
```

---

## üéØ Post-Deployment

### Verify Checklist
- [ ] All services running
- [ ] Health endpoints green
- [ ] Contract deployed and active
- [ ] Oracle authorized in contract
- [ ] Frontend accessible
- [ ] Demo scenarios pass
- [ ] Monitoring setup
- [ ] Backups configured

### Share Links
- Frontend: `https://app.yourdomain.com`
- API Docs: `https://api.yourdomain.com/docs`
- Status: `https://status.yourdomain.com`
- GitHub: `https://github.com/yourorg/qubic-escrow`

---

**Deployment Version**: 1.0.0  
**Last Updated**: December 2025